clone:
  git:
    image: plugins/git
    volumes:
    - /var/repos/${DRONE_REPO_OWNER}/${DRONE_REPO_NAME}:/drone/src/github.com/${DRONE_REPO_OWNER}/${DRONE_REPO_NAME}
pipeline:
  test:
    image: scireum/sirius-build
    commands:
      - mvn clean test
    volumes:
      - /root/.m2:/root/.m2
      - /var/repos/${DRONE_REPO_OWNER}/${DRONE_REPO_NAME}:/drone/src/github.com/${DRONE_REPO_OWNER}/${DRONE_REPO_NAME}
    when:
      event: [push, pull_request]
  deploy:
    image: scireum/sirius-build
    commands:
      - mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent sonar:sonar -Dsonar.projectKey=sirius-db -Dbuild.version=${DRONE_TAG}
      - mvn clean deploy -Dbuild.version=${DRONE_TAG}
    volumes:
      - /root/.m2:/root/.m2
      - /root/.gnupg:/root/.gnupg
      - /var/repos/${DRONE_REPO_OWNER}/${DRONE_REPO_NAME}:/drone/src/github.com/${DRONE_REPO_OWNER}/${DRONE_REPO_NAME}
    when:
      event: tag
